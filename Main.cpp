#include <Windows.h>
#include <detours.h>

#include <iostream>
#include <tchar.h>
#include <cstdio>

#include <fstream>
#include <filesystem>

void deleteFilesInDirectory(const wchar_t*);
void AppendLineToFile(const std::string& filePath, const std::string& line);

const char* infectedFile = "C:\\malwareTraces\\infected.txt";
LPCSTR dllPath = "C:\\malwareTraces\\MalwareTracesDll.dll";
const wchar_t* infoFolderPath = L"C:\\malwareTraces\\packet_info";

int main(int argc, char* argv[]) 
{
    remove(infectedFile);
    deleteFilesInDirectory(infoFolderPath);

    if (argc < 2) { return -1; }
    const char* malwareNameStr = argv[1];
    int len = strlen(malwareNameStr) + 1;
    int requiredSize = MultiByteToWideChar(CP_ACP, 0, malwareNameStr, len, NULL, 0);
    TCHAR* malwarePath;
    if (requiredSize <= 0) { return -1; }
    malwarePath = new TCHAR[requiredSize];
    MultiByteToWideChar(CP_ACP, 0, malwareNameStr, len, malwarePath, requiredSize);

    TCHAR* arguments = NULL;
    if (argc == 3) {
        //std::cout << argv[2] << std::endl;
        const char* malwareArgsStr = argv[2];
        int len = strlen(malwareArgsStr) + 1;
        int requiredSize = MultiByteToWideChar(CP_ACP, 0, malwareArgsStr, len, NULL, 0);
        if (requiredSize <= 0) { return -1; }
        arguments = new TCHAR[requiredSize];
        MultiByteToWideChar(CP_ACP, 0, malwareArgsStr, len, arguments, requiredSize);
    }
    else {
    }

    PROCESS_INFORMATION pi = { 0 };
    STARTUPINFO si = { sizeof(si) };

    BOOL success = DetourCreateProcessWithDllEx(
        (LPCTSTR) malwarePath,
        (LPTSTR) arguments,     // Command line
        NULL,                   // Application security descriptor
        NULL,                   // Process security descriptor
        FALSE,                  // Inherit handles
        CREATE_SUSPENDED,                      // Creation flags
        NULL,                   // Environment
        NULL,                   // Current directory
        &si,                    // Startup info
        &pi,                    // Process information
        //1,                    // Number of DLLs to inject
        dllPath,                // Array of DLL paths to inject
        NULL                    // Detoured entry for injected DLLs
    );

    if (!success) {
        DWORD error = GetLastError();
        std::cerr << "Failed to start the target process with DLL injection. Error code: " << error << std::endl;
    }

    char infectedInfo[256];
    sprintf_s(infectedInfo, sizeof(infectedInfo), "%d -1", pi.dwProcessId);
    AppendLineToFile(infectedFile, infectedInfo);

    ResumeThread(pi.hThread);

    WaitForSingleObject(pi.hProcess, INFINITE);

    CloseHandle(pi.hThread);
    CloseHandle(pi.hProcess);

    return 0;
}

void deleteFilesInDirectory(const wchar_t *folderPath) {
    WIN32_FIND_DATAW findFileData;
    wchar_t searchPath[MAX_PATH];
    HANDLE hFind;

    swprintf(searchPath, MAX_PATH, L"%s\\*", folderPath);
    hFind = FindFirstFileW(searchPath, &findFileData);

    if (hFind == INVALID_HANDLE_VALUE) {
        printf("No files found in the directory.\n");
        return;
    }

    do {
        if (findFileData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY) { continue; }
        swprintf(searchPath, MAX_PATH, L"%s\\%s", folderPath, findFileData.cFileName);
        DeleteFileW(searchPath);
    } while (FindNextFileW(hFind, &findFileData) != 0);

    FindClose(hFind);
}

void AppendLineToFile(const std::string& filePath, const std::string& line) {
    std::ofstream file(filePath, std::ios::app);

    if (file.is_open()) {
        file << line << std::endl;
        file.close();
    } else {
        std::cerr << "Error: Unable to open file for appending." << std::endl;
    }
}
